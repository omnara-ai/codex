Omnara × Codex Integration — Architecture & Guide

Overview

- Goal: Let Codex (Rust CLI/TUI) send rich session events to Omnara, accept remote input/approvals, and capture git diffs — all with minimal impact to Codex UX.
- Scope:
  - Agent/user messages mirrored to Omnara
  - Dual-source approvals (Omnara and local TUI) with race resolution
  - Single polling loop for remote input
  - Tool/patch event notes (non-approval) with clean Markdown formatting
  - Git diff attachment (only when changed)

Runtime Entry

- Python CLI: `omnara --agent codex` (omnara/cli.py → omnara/agents/codex.py)
  - Resolves a codex binary bundled in the wheel at `omnara/_bin/codex/<platform-arch>/codex`
  - Dev fallback: uses local `integrations/cli_wrappers/codex/codex-rs/target/release/codex` if present
  - Exports env used by Codex integration:
    - `OMNARA_API_KEY` (required)
    - `OMNARA_API_URL` (optional; defaults to hosted URL)
    - `OMNARA_SESSION_ID` (optional; if unset, a new UUID is generated by the Python runner)

Rust Components (paths)

- Core client and diff tracker
  - `core/src/omnara_client.rs`
    - Minimal HTTP surface to Omnara
    - Tracks last agent message id and runs a single polling task
    - Appends per-session logs to `~/.omnara/codex_wrapper/<session_id>.log`
    - Central place that attaches `git_diff` when changed (calls the tracker)
  - `core/src/git_diff_tracker.rs`
    - Mirrors Python’s git_utils; captures baseline and returns combined diff (committed+uncommitted) + untracked files created after session start
    - Deduplicates diffs via SHA-1 of trimmed content

- TUI integration and formatting helpers
  - `tui/src/omnara_integration.rs` (OmnaraBridge)
    - Thin bridge over core client:
      - on_session_start: sends startup message and starts polling
      - on_task_complete: requests user input and starts polling
      - send_note: fire-and-forget informational messages to Omnara
      - send_exec_approval_request / send_patch_approval_request: dual-source approvals with [OPTIONS]
    - Note: The bridge does NOT compute git diffs; the client adds `git_diff` centrally
  - `tui/src/omnara_format.rs`
    - Centralized Markdown formatters for Omnara notes and prompts:
      - `format_patch_details`, `format_patch_note` (100-line diff truncation)
      - `format_exec_note` (bold headers, trimmed output preview)
      - `format_mcp_begin_note`, `format_mcp_end_note`
      - `format_exec_approval_request`, `format_patch_approval_request`
  - `tui/src/chatwidget.rs`
    - Hooks Codex events to OmnaraBridge:
      - Patch apply begin → non-approval patch note (summary + diff)
      - Exec end → non-approval exec note
      - MCP begin/end → non-approval tool call notes
      - Approval requests → OmnaraBridge (and local modal)

HTTP Endpoints (client)

- `POST /api/v1/messages/agent`
  - Body fields used: `agent_instance_id`, `content`, `requires_user_input`, optional `git_diff`, and `agent_type = "codex"`
- `PATCH /api/v1/messages/{id}/request-input`
  - Request input on the last message (deterministically gated by last-agent-message-id)
- `GET /api/v1/messages/pending?agent_instance_id=...&last_read_message_id=...`
  - Polls for pending messages (single poller); stops after delivering messages or on cancellation/timeout/stale
- `POST /api/v1/sessions/end`
  - Best-effort on shutdown for clean session ends

Polling & Input Lifecycle

- Sending an agent message (requires_user_input=false):
  - Records the returned message id for future request-input calls
  - Does not automatically request input unless it’s a “task complete” case handled by TUI
- When a task completes (or CTRL-C indicates an interrupt):
  - Request user input for the last agent message
  - Start a single polling loop; remote user messages are:
    - Inserted into TUI history (as if typed)
    - Forwarded to Codex agent as `Op::UserInput`
- Cancelling polling: any local user input cancels the active poller

Approvals (dual source)

- Exec approvals (`send_exec_approval_request`) and Patch approvals (`send_patch_approval_request`):
  - Always show a local approval modal
  - Send an Omnara approval prompt with `[OPTIONS]` (Yes/Always/No, provide feedback)
  - Whichever decision arrives first (Omnara or local) resolves the approval
  - Patch prompts include a summary and optional diff details

What Gets Mirrored to Omnara (non-approval notes)

- Patch apply begin
  - `✏️ Applying patch to N file(s) (+X -Y)`
  - File list, then diff details in a ```diff code block (truncated to 100 lines)
- Exec command end
  - `**Exec:** `command`
     **Status:** Success/Failed (exit N)`
  - Optional output preview in a ```text code block (trimmed)
- MCP tool begin/end
  - `**Tool:** server.tool(args)` + `**Status:** Running/Success/Failed`

Git Diff Attachment

- Tracker: `core/src/git_diff_tracker.rs`
  - Captures the initial commit hash; computes a unified diff from that baseline to current working tree
  - Includes untracked files created after session start in a diff-like format
  - Excludes other worktrees via `git worktree list --porcelain` and `:(exclude)relative/path`
  - `get_diff_if_changed()` returns a non-empty diff only if it’s different from the last returned diff (SHA-1 based)
- Client behavior: `omnara_client.rs::send_agent_message`
  - Calls `get_diff_if_changed()` and includes `git_diff` only when changed
  - Callers do not need to manage diffs — it’s fully centralized

Logging

- Per-session logs: `~/.omnara/codex_wrapper/<session_id>.log`
  - High-level markers for sends, polling start/stop, and error statuses
  - No extra non-Omnara logs added; Codex’s existing logs unchanged

Environment Variables

- `OMNARA_API_KEY` (required)
- `OMNARA_API_URL` (optional; defaults to hosted URL)
- `OMNARA_SESSION_ID` (optional; UUID set by Python launcher if missing)

Packaging & Release

- Binaries are prebuilt and bundled inside the Python wheel under `omnara/_bin/codex/<platform-arch>/`:
  - macOS: `darwin-x64`, `darwin-arm64`
  - Linux: `linux-x64`
  - Windows: `win-x64`
- GitHub Actions: `.github/workflows/build-codex-wheels.yml`
  - Trigger: GitHub Release published
  - Per platform: build codex (cargo), copy into package, build wheel
  - Smoke test: `python -m omnara --agent codex -- --version`
  - Publish: uploads all wheels to PyPI (requires `PYPI_API_TOKEN`)

Key Entry Points — Quick Index

- Python
  - `omnara/cli.py` — `--agent codex` wiring
  - `omnara/agents/codex.py` — resolves binary, sets env, runs Codex
- Rust (codex-rs workspace)
  - Core: `core/src/omnara_client.rs`, `core/src/git_diff_tracker.rs`
  - TUI bridge: `tui/src/omnara_integration.rs`
  - TUI formatting: `tui/src/omnara_format.rs`
  - TUI event glue: `tui/src/chatwidget.rs`
  - CLI bin (invoke Codex): `cli/src/main.rs`

Guiding Principles

- Single responsibility:
  - Client owns Omnara protocol mechanics and diff attachment
  - TUI bridge owns UI ↔ Omnara orchestration and approvals
  - Formatting isolated in `omnara_format.rs`
- Safe defaults:
  - Single poller at a time; cancelled on local input
  - Approval race resolved deterministically
  - Git diff attached only when changed
- Minimal intrusion:
  - Logs and existing TUI behavior preserved
  - Integration files are self-contained and referenced above

